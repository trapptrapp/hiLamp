<!DOCTYPE html>
<html lang="pt-br">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Hi Lamp</title>

	<link rel="stylesheet" href="styles/main.css">

</head>

<body>
	<div id="page-home">


		<h1>Controle de Iluminação</h1>
		<div style="float:left;">
			<h2>Reading tag values</h2>
			<div style="float:left;">
				<h2>1º Andar:</h2>

				Andar 1 -> Corredor status: <span data-ix-tag="Application_Andar_1_Portaria_IN_Iluminacao_1pav_Corredor"
					data-ix-refresh="interval">Carregando...</span><br />

				Andar 1 -> Circuito 1 status: <span
					data-ix-tag="Application_Andar_1_Portaria_IN_Iluminacao_1pav_Circuito1"
					data-ix-refresh="interval">Carregando...</span><br />

				Andar 1 -> Circuito 2 status: <span
					data-ix-tag="Application_Andar_1_Portaria_IN_Iluminacao_1pav_Circuito2"
					data-ix-refresh="interval">Carregando...</span><br />

				Andar 1 -> Circuito 3 status: <span
					data-ix-tag="Application_Andar_1_Portaria_IN_Iluminacao_1pav_Circuito3"
					data-ix-refresh="interval">Carregando...</span><br />

				Andar 1 -> Entrada status: <span data-ix-tag="Application_Andar_1_Portaria_IN_Iluminacao_1pav_Recepcao"
					data-ix-refresh="interval">Carregando...</span><br />


				<h2>2º Andar:</h2>

				Andar 2 -> Corredor status: <span data-ix-tag="Application_Andar_2_IN_Iluminacao_2pav_Corredor"
					data-ix-refresh="interval">Carregando...</span><br />

				Andar 2 -> Circuito 1 status: <span data-ix-tag="Application_Andar_2_IN_Iluminacao_2pav_Circuito1"
					data-ix-refresh="interval">Carregando...</span><br />

				Andar 2 -> Circuito 2 status: <span data-ix-tag="Application_Andar_2_IN_Iluminacao_2pav_Circuito2"
					data-ix-refresh="interval">Carregando...</span><br />

				Andar 2 -> Circuito 3 status: <span data-ix-tag="Application_Andar_2_IN_Iluminacao_2pav_Circuito3"
					data-ix-refresh="interval">Carregando...</span><br />

				Andar 2 -> Banheiro status: <span data-ix-tag="Application_Andar_2_IN_Iluminacao_2pav_Banheiro"
					data-ix-refresh="interval">Carregando...</span><br />


				<h2>3º Andar:</h2>

				Andar 3 -> Corredor status: <span data-ix-tag="Application_Andar_3_IN_Iluminacao_3pav_Corredor"
					data-ix-refresh="interval">Carregando...</span><br />

				Andar 3 -> Circuito 1 status: <span data-ix-tag="Application_Andar_3_IN_Iluminacao_3pav_Circuito1"
					data-ix-refresh="interval">Carregando...</span><br />

				Andar 3 -> Circuito 2 status: <span data-ix-tag="Application_Andar_3_IN_Iluminacao_3pav_Circuito2"
					data-ix-refresh="interval">Carregando...</span><br />

				Andar 3 -> Circuito 3 status: <span data-ix-tag="Application_Andar_3_IN_Iluminacao_3pav_Circuito3"
					data-ix-refresh="interval">Carregando...</span><br />

				Andar 3 -> Banheiro status: <span data-ix-tag="Application_Andar_3_IN_Iluminacao_3pav_Banheiro"
					data-ix-refresh="interval">Carregando...</span><br />


				<h2>Garagem:</h2>

				Garagem -> Garagem subsolo: <span data-ix-tag="Application_Garagem_IN_Iluminacao_Garagem1"
					data-ix-refresh="interval">Carregando...</span><br />

				Garagem -> Garagem servidor: <span data-ix-tag="Application_Garagem_IN_Iluminacao_Garagem3"
					data-ix-refresh="interval">Carregando...</span><br />

				Garagem -> Garagem corredor: <span data-ix-tag="Application_Garagem_IN_Iluminacao_Garagem2"
					data-ix-refresh="interval">Carregando...</span><br />

			</div>


			<div style="float:left; margin-left: 50px;">
				<h2>Writing tag values</h2>
				<div style="float:left;">
					<h2>1º Andar:</h2>

					Corredor: <input type="number"
						data-ix-setter="Application_Andar_1_Portaria_IN_Iluminacao_1pav_Corredor"
						id="Application_Andar_1_Portaria_IN_Iluminacao_1pav_Corredor" />&nbsp;&nbsp;
					<button
						data-ix-submitbutton="Application_Andar_1_Portaria_IN_Iluminacao_1pav_Corredor">Set</button><br />

					Circuito 1: <input type="number"
						data-ix-setter="Application_Andar_1_Portaria_IN_Iluminacao_1pav_Circuito1"
						id="Application_Andar_1_Portaria_IN_Iluminacao_1pav_Circuito1" />&nbsp;&nbsp;
					<button
						data-ix-submitbutton="Application_Andar_1_Portaria_IN_Iluminacao_1pav_Circuito1">Set</button><br />

					Circuito 2: <input type="number"
						data-ix-setter="Application_Andar_1_Portaria_IN_Iluminacao_1pav_Circuito2"
						id="Application_Andar_1_Portaria_IN_Iluminacao_1pav_Circuito2" />&nbsp;&nbsp;
					<button
						data-ix-submitbutton="Application_Andar_1_Portaria_IN_Iluminacao_1pav_Circuito2">Set</button><br />

					Circuito 3: <input type="number"
						data-ix-setter="Application_Andar_1_Portaria_IN_Iluminacao_1pav_Circuito3"
						id="Application_Andar_1_Portaria_IN_Iluminacao_1pav_Circuito3" />&nbsp;&nbsp;
					<button
						data-ix-submitbutton="Application_Andar_1_Portaria_IN_Iluminacao_1pav_Circuito3">Set</button><br />

					Entrada: <input type="number"
						data-ix-setter="Application_Andar_1_Portaria_IN_Iluminacao_1pav_Recepcao"
						id="Application_Andar_1_Portaria_IN_Iluminacao_1pav_Recepcao" />&nbsp;&nbsp;
					<button
						data-ix-submitbutton="Application_Andar_1_Portaria_IN_Iluminacao_1pav_Recepcao">Set</button><br />

					<h2>2º Andar:</h2>

					Corredor: <input type="number"
						data-ix-setter="Application_Andar_2_IN_Iluminacao_2pav_Corredor"
						id="Application_Andar_2_IN_Iluminacao_2pav_Corredor" />&nbsp;&nbsp;
					<button data-ix-submitbutton="Application_Andar_2_IN_Iluminacao_2pav_Corredor">Set</button><br />

					Circuito 1: <input type="number"
						data-ix-setter="Application_Andar_2_IN_Iluminacao_2pav_Circuito1"
						id="Application_Andar_2_IN_Iluminacao_2pav_Circuito1" />&nbsp;&nbsp;
					<button data-ix-submitbutton="Application_Andar_2_IN_Iluminacao_2pav_Circuito1">Set</button><br />

					Circuito 2: <input type="number"
						data-ix-setter="Application_Andar_2_IN_Iluminacao_2pav_Circuito2"
						id="Application_Andar_2_IN_Iluminacao_2pav_Circuito2" />&nbsp;&nbsp;
					<button data-ix-submitbutton="Application_Andar_2_IN_Iluminacao_2pav_Circuito2">Set</button><br />

					Circuito 3: <input type="number"
						data-ix-setter="Application_Andar_2_IN_Iluminacao_2pav_Circuito3"
						id="Application_Andar_2_IN_Iluminacao_2pav_Circuito3" />&nbsp;&nbsp;
					<button data-ix-submitbutton="Application_Andar_2_IN_Iluminacao_2pav_Circuito3">Set</button><br />

					Banheiro: <input type="number"
						data-ix-setter="Application_Andar_2_IN_Iluminacao_2pav_Banheiro"
						id="Application_Andar_2_IN_Iluminacao_2pav_Banheiro" />&nbsp;&nbsp;
					<button data-ix-submitbutton="Application_Andar_2_IN_Iluminacao_2pav_Banheiro">Set</button><br />

					<h2>3º Andar:</h2>

					Corredor: <input type="number"
						data-ix-setter="Application_Andar_3_IN_Iluminacao_3pav_Circuito1"
						id="Application_Andar_3_IN_Iluminacao_3pav_Circuito1" />&nbsp;&nbsp;
					<button data-ix-submitbutton="Application_Andar_3_IN_Iluminacao_3pav_Circuito1">Set</button><br />

					Circuito 1: <input type="number"
						data-ix-setter="Application_Andar_3_IN_Iluminacao_3pav_Corredor"
						id="Application_Andar_3_IN_Iluminacao_3pav_Corredor" />&nbsp;&nbsp;
					<button data-ix-submitbutton="Application_Andar_3_IN_Iluminacao_3pav_Corredor">Set</button><br />

					Circuito 2: <input type="number"
						data-ix-setter="Application_Andar_3_IN_Iluminacao_3pav_Circuito2"
						id="Application_Andar_3_IN_Iluminacao_3pav_Circuito2" />&nbsp;&nbsp;
					<button data-ix-submitbutton="Application_Andar_3_IN_Iluminacao_3pav_Circuito2">Set</button><br />

					Circuito 3: <input type="text"
						data-ix-setter="Application_Andar_3_IN_Iluminacao_3pav_Circuito3"
						id="Application_Andar_3_IN_Iluminacao_3pav_Circuito3" />&nbsp;&nbsp;
					<button
						data-ix-submitbutton="Application_Andar_3_IN_Iluminacao_3pav_Circuito3">
						Set
					</button><br />

					Banheiro: <input type="number"
						data-ix-setter="Application_Andar_3_IN_Iluminacao_3pav_Banheiro"
						id="Application_Andar_3_IN_Iluminacao_3pav_Banheiro" />&nbsp;&nbsp;
					<button data-ix-submitbutton="Application_Andar_3_IN_Iluminacao_3pav_Banheiro">Set</button><br />

					<h2>Garagem:</h2>

					Garagem subsolo: <input type="number"
						data-ix-setter="Application_Garagem_IN_Iluminacao_Garagem1"
						id="Application_Garagem_IN_Iluminacao_Garagem1" />&nbsp;&nbsp;
					<button data-ix-submitbutton="Application_Garagem_IN_Iluminacao_Garagem1">Set</button><br />

					Garagem servidor: <input type="number"
						data-ix-setter="Application_Garagem_IN_Iluminacao_Garagem3"
						id="Application_Garagem_IN_Iluminacao_Garagem3" />&nbsp;&nbsp;
					<button data-ix-submitbutton="Application_Garagem_IN_Iluminacao_Garagem3">Set</button><br />

					Garagem corredor: <input type="number"
						data-ix-setter="Application_Garagem_IN_Iluminacao_Garagem2"
						id="Application_Garagem_IN_Iluminacao_Garagem2" />&nbsp;&nbsp;
					<button data-ix-submitbutton="Application_Garagem_IN_Iluminacao_Garagem2">Set</button><br />

				</div>

				<div style="clear:both;"></div>
			</div>
			<script>
				const circuitos = document.getElementsByTagName('span')
				const buttons = document.getElementsByTagName('button')
				const circuitosArr = []
				let getPayload = []
				addListennersToButtons()

				function addListennersToButtons() {
					for (let i = 0; i < buttons.length; i++) {
						const button = buttons.item(i)
						button.addEventListener('click', async () => {
							const inputValue = document.getElementById(button.dataset.ixSubmitbutton).value
							const res = await fetch('/lampada', {
								method: 'POST',
								headers: {
									'Content-Type': 'application/json'
								},
								body: JSON.stringify([{ name: button.dataset.ixSubmitbutton, value: inputValue || false }])
							})
							const resJson = await res.json()
							// await getStatus()
							console.log(resJson)
						})
					}
				}

				function makeGetLightStatusPayload() {
					getPayload = []
					for (let i = 0; i < circuitos.length; i++) {
						circuitosArr.push(circuitos.item(i))
						getPayload.push(circuitos.item(i).dataset.ixTag)
					}
				}

				// setInterval(async () => {
				// 	makeGetLightStatusPayload()
				// 	await getStatus()
				// }, 5000)

				async function getStatus() {
					const res = await fetch('/lampada/getStatus', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(getPayload)
					})
					const resJson = await res.json();
					setAllLightStatus(resJson.data)
				}

				function setAllLightStatus(tags) {
					if (!tags) return
					const currentTagsStatus = JSON.parse(tags.substr(1))
					currentTagsStatus.tags.map(tag => {
						const currentTagSpan = circuitosArr.filter(spanTag => spanTag.dataset.ixTag === tag.name)
						if (!currentTagSpan.length) return;
						currentTagSpan[0].innerText = tag.value ? 'Ligada' : 'Desligada'
					})
				}
			</script>
</body>
</html>